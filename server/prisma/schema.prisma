generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model allowed_email_domains {
  id              String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  organization_id String        @db.Uuid
  domain          String
  is_active       Boolean?      @default(true)
  created_at      DateTime?     @default(now()) @db.Timestamptz(6)
  created_by      String?       @db.Uuid
  organizations   organizations @relation(fields: [organization_id], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@unique([organization_id, domain])
  @@index([domain], map: "idx_allowed_email_domains_domain")
}

model characteristic_level_1 {
  id               String             @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  organization_id  String             @db.Uuid
  code             String
  name             String
  is_active        Boolean?           @default(true)
  created_at       DateTime?          @default(now()) @db.Timestamptz(6)
  created_by       String?            @db.Uuid
  organizations    organizations      @relation(fields: [organization_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  reference_orders reference_orders[]

  @@unique([organization_id, code])
}

model characteristic_level_2 {
  id               String             @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  organization_id  String             @db.Uuid
  code             String
  name             String
  is_active        Boolean?           @default(true)
  created_at       DateTime?          @default(now()) @db.Timestamptz(6)
  created_by       String?            @db.Uuid
  organizations    organizations      @relation(fields: [organization_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  reference_orders reference_orders[]

  @@unique([organization_id, code])
}

model characteristic_level_3 {
  id               String             @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  organization_id  String             @db.Uuid
  code             String
  name             String
  is_active        Boolean?           @default(true)
  created_at       DateTime?          @default(now()) @db.Timestamptz(6)
  created_by       String?            @db.Uuid
  organizations    organizations      @relation(fields: [organization_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  reference_orders reference_orders[]

  @@unique([organization_id, code])
}

model chat_threads {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id    String   @db.Uuid
  thread_id  String
  created_at DateTime @default(now()) @db.Timestamptz(6)
  updated_at DateTime @default(now()) @db.Timestamptz(6)

  @@index([user_id], map: "idx_chat_threads_user_id")
}

model nfe_documents {
  id                   String               @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  test_execution_id    String               @db.Uuid
  organization_id      String               @db.Uuid
  billing_document     String
  nfe_number           String
  status               String               @default("fetched")
  nfe_header_data      Json
  nfe_items_data       Json?
  nfe_tax_data         Json?
  fetched_at           DateTime?            @default(now()) @db.Timestamptz(6)
  created_at           DateTime?            @default(now()) @db.Timestamptz(6)
  updated_at           DateTime?            @default(now()) @db.Timestamptz(6)
  organizations        organizations        @relation(fields: [organization_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  test_flow_executions test_flow_executions @relation(fields: [test_execution_id], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([test_execution_id], map: "idx_nfe_documents_execution")
  @@index([organization_id], map: "idx_nfe_documents_org")
}

model organizations {
  id                     String                   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name                   String
  slug                   String                   @unique
  logo_url               String?
  spaider_logo_url       String?
  primary_color          String?                  @default("#6366f1")
  secondary_color        String?                  @default("#8b5cf6")
  ai_instructions        String?                  @default("Você é um assistente de testes SAP. Ajude o usuário a testar ordens de vendas.")
  created_at             DateTime?                @default(now()) @db.Timestamptz(6)
  updated_at             DateTime?                @default(now()) @db.Timestamptz(6)
  allowed_email_domains  allowed_email_domains[]
  characteristic_level_1 characteristic_level_1[]
  characteristic_level_2 characteristic_level_2[]
  characteristic_level_3 characteristic_level_3[]
  nfe_documents          nfe_documents[]
  profiles               profiles[]
  reference_orders       reference_orders[]
  sap_domain_credentials sap_domain_credentials[]
  test_flow_executions   test_flow_executions[]
  user_roles             user_roles[]
}

model auth_users {
  id              String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  email           String    @unique
  password_hash   String
  email_confirmed Boolean   @default(false)
  created_at      DateTime  @default(now()) @db.Timestamptz(6)
  updated_at      DateTime  @default(now()) @db.Timestamptz(6)
  last_login_at   DateTime? @db.Timestamptz(6)
  profile_id      String?   @unique @db.Uuid
  
  // Relacionamento com profile
  profile         profiles? @relation(fields: [profile_id], references: [id])

  @@index([email], map: "idx_auth_users_email")
}

model profiles {
  id              String        @id @db.Uuid
  organization_id String        @db.Uuid
  full_name       String?
  email           String
  avatar_url      String?
  is_super_admin  Boolean       @default(false)
  created_at      DateTime?     @default(now()) @db.Timestamptz(6)
  updated_at      DateTime?     @default(now()) @db.Timestamptz(6)
  organizations   organizations @relation(fields: [organization_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  auth_user       auth_users?

  @@index([email], map: "idx_profiles_email")
  @@index([organization_id], map: "idx_profiles_organization_id")
}

model reference_orders {
  id                     String                  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  organization_id        String                  @db.Uuid
  order_number           String
  description            String?
  order_type             String                  @default("venda_normal")
  domain                 String?
  sap_doc_type           String?
  warehouse_code         String?
  characteristic_1_id    String?                 @db.Uuid
  characteristic_2_id    String?                 @db.Uuid
  characteristic_3_id    String?                 @db.Uuid
  contract_reference     String?
  quotation_reference    String?
  delivery_reference     String?
  invoice_reference      String?
  docnum_reference       String?
  supports_contract      Boolean?                @default(false)
  supports_quotation     Boolean?                @default(false)
  supports_sales_order   Boolean?                @default(true)
  supports_delivery      Boolean?                @default(false)
  supports_invoice       Boolean?                @default(false)
  supports_fiscal_note   Boolean?                @default(false)
  is_active              Boolean?                @default(true)
  created_at             DateTime?               @default(now()) @db.Timestamptz(6)
  created_by             String?                 @db.Uuid
  characteristic_level_1 characteristic_level_1? @relation(fields: [characteristic_1_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  characteristic_level_2 characteristic_level_2? @relation(fields: [characteristic_2_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  characteristic_level_3 characteristic_level_3? @relation(fields: [characteristic_3_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  organizations          organizations           @relation(fields: [organization_id], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([domain], map: "idx_reference_orders_domain")
  @@index([order_number], map: "idx_reference_orders_order_number")
  @@index([organization_id], map: "idx_reference_orders_org")
}

model sap_domain_credentials {
  id              String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  organization_id String        @db.Uuid
  domain          String        // Identificador único do domínio (ex: "teiaconnect")
  display_name    String        // Nome amigável (ex: "Teia Connect")
  
  // Credenciais SAP (senha criptografada com AES-256)
  base_url        String?       // URL base do SAP (ex: "https://vm57.4hub.cloud:44357")
  sap_username    String?       // Usuário SAP (ex: "CFARIA")
  sap_password    String?       // Senha criptografada
  
  // APIs disponíveis
  has_sales_order_api     Boolean   @default(true)
  has_delivery_api        Boolean   @default(true)
  has_billing_api         Boolean   @default(false)
  has_nfe_api             Boolean   @default(false)
  
  // Status da conexão
  last_test_at    DateTime?     @db.Timestamptz(6)
  last_test_ok    Boolean?      @default(false)
  
  // Campos legados (manter compatibilidade)
  secret_suffix   String?
  logo_url        String?
  is_active       Boolean?      @default(true)
  created_at      DateTime?     @default(now()) @db.Timestamptz(6)
  updated_at      DateTime?     @default(now()) @db.Timestamptz(6)
  created_by      String?       @db.Uuid
  organizations   organizations @relation(fields: [organization_id], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@unique([organization_id, domain])
  @@index([organization_id], map: "idx_sap_credentials_org")
}

model test_flow_executions {
  id                          String                        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  run_id                      String
  test_id                     String
  user_id                     String                        @db.Uuid
  organization_id             String                        @db.Uuid
  order_id                    String
  original_order_id           String?
  sap_domain                  String?
  test_type                   String?                       @default("fluxo_completo")
  global_status               String?
  total_steps                 Int?                          @default(6)
  completed_steps             Int?                          @default(0)
  failed_steps                Int?                          @default(0)
  errors                      Json?
  order_data                  Json?
  order_status                String?                       @default("completed")
  order_enabled               Boolean?                      @default(true)
  delivery_id                 String?
  delivery_data               Json?
  delivery_status             String?
  delivery_enabled            Boolean?                      @default(false)
  picking_status              String?
  pgi_status                  String?
  billing_id                  String?
  billing_data                Json?
  billing_status              String?
  billing_enabled             Boolean?                      @default(false)
  nfe_number                  String?
  nfe_data                    Json?
  nfe_reference_data          Json?
  nfe_status                  String?
  nfe_enabled                 Boolean?                      @default(false)
  nfe_differences             Int?                          @default(0)
  nfe_comparison_summary      Json?
  raw_comparison_data         Json?
  total_differences           Int?                          @default(0)
  sections_with_differences   String[]
  created_at                  DateTime?                     @default(now()) @db.Timestamptz(6)
  updated_at                  DateTime?                     @default(now()) @db.Timestamptz(6)
  nfe_documents               nfe_documents[]
  organizations               organizations                 @relation(fields: [organization_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  test_header_comparisons     test_header_comparisons[]
  test_item_comparisons       test_item_comparisons[]
  test_nfe_header_comparisons test_nfe_header_comparisons[]
  test_nfe_item_comparisons   test_nfe_item_comparisons[]
  test_nfe_tax_comparisons    test_nfe_tax_comparisons[]
  test_tax_comparisons        test_tax_comparisons[]

  @@index([organization_id], map: "idx_test_flow_executions_org")
  @@index([run_id], map: "idx_test_flow_executions_run_id")
  @@index([user_id], map: "idx_test_flow_executions_user")
}

model test_header_comparisons {
  id                   String               @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  test_execution_id    String               @db.Uuid
  field_name           String
  field_path           String?
  original_value       String?
  new_value            String?
  is_identical         Boolean
  created_at           DateTime?            @default(now()) @db.Timestamptz(6)
  test_flow_executions test_flow_executions @relation(fields: [test_execution_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([test_execution_id], map: "idx_test_header_comparisons_execution")
}

model test_item_comparisons {
  id                   String               @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  test_execution_id    String               @db.Uuid
  item_number          String
  item_position        Int?
  field_name           String
  field_path           String?
  original_value       String?
  new_value            String?
  is_identical         Boolean
  created_at           DateTime?            @default(now()) @db.Timestamptz(6)
  test_flow_executions test_flow_executions @relation(fields: [test_execution_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([test_execution_id], map: "idx_test_item_comparisons_execution")
}

model test_nfe_header_comparisons {
  id                   String               @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  test_execution_id    String               @db.Uuid
  field_name           String
  field_path           String?
  original_value       String?
  new_value            String?
  is_identical         Boolean
  created_at           DateTime?            @default(now()) @db.Timestamptz(6)
  test_flow_executions test_flow_executions @relation(fields: [test_execution_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([test_execution_id], map: "idx_test_nfe_header_comparisons_execution")
}

model test_nfe_item_comparisons {
  id                   String               @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  test_execution_id    String               @db.Uuid
  item_number          String
  item_position        Int?
  field_name           String
  field_path           String?
  original_value       String?
  new_value            String?
  is_identical         Boolean
  created_at           DateTime?            @default(now()) @db.Timestamptz(6)
  test_flow_executions test_flow_executions @relation(fields: [test_execution_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([test_execution_id], map: "idx_test_nfe_item_comparisons_execution")
}

model test_nfe_tax_comparisons {
  id                   String               @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  test_execution_id    String               @db.Uuid
  item_number          String
  tax_type             String
  original_rate        String?
  original_base        String?
  original_base_value  String?
  original_amount      String?
  new_rate             String?
  new_base             String?
  new_base_value       String?
  new_amount           String?
  has_differences      Boolean
  differences_list     String[]
  created_at           DateTime?            @default(now()) @db.Timestamptz(6)
  test_flow_executions test_flow_executions @relation(fields: [test_execution_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([test_execution_id], map: "idx_test_nfe_tax_comparisons_execution")
}

model test_tax_comparisons {
  id                   String               @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  test_execution_id    String               @db.Uuid
  item_number          String
  tax_type             String
  original_rate        String?
  original_base        String?
  original_base_value  String?
  original_amount      String?
  new_rate             String?
  new_base             String?
  new_base_value       String?
  new_amount           String?
  has_differences      Boolean
  differences_list     String[]
  created_at           DateTime?            @default(now()) @db.Timestamptz(6)
  test_flow_executions test_flow_executions @relation(fields: [test_execution_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([test_execution_id], map: "idx_test_tax_comparisons_execution")
}

model user_roles {
  id              String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id         String        @db.Uuid
  organization_id String        @db.Uuid
  role            app_role      @default(user)
  created_at      DateTime?     @default(now()) @db.Timestamptz(6)
  organizations   organizations @relation(fields: [organization_id], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@unique([user_id, organization_id])
  @@index([organization_id], map: "idx_user_roles_organization_id")
  @@index([user_id], map: "idx_user_roles_user_id")
}

enum app_role {
  admin
  user
  super_admin
}

enum characteristic_level {
  level_1
  level_2
  level_3
}

// Logs de requisições SAP para debugging
model sap_request_logs {
  id                  String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id             String?   @db.Uuid
  organization_id     String?   @db.Uuid
  test_execution_id   String?   @db.Uuid
  
  // Informações da operação
  operation           String    // "createSalesOrder", "createDelivery", "pickAllItems", etc.
  http_method         String    // "POST", "GET", "PATCH"
  endpoint            String    // URL completa
  
  // Payloads
  request_headers     Json?     // Headers enviados (sem auth)
  request_payload     Json?     // JSON enviado
  response_payload    Json?     // Resposta do SAP
  
  // Status
  response_status     Int?      // 200, 400, 500
  success             Boolean   @default(false)
  error_code          String?   // "CX_SD_SLS_INTEGRATION"
  error_message       String?   // Mensagem de erro
  
  // Métricas
  duration_ms         Int?      // Tempo de execução
  
  // Timestamps
  created_at          DateTime  @default(now()) @db.Timestamptz(6)
  
  @@index([user_id], map: "idx_sap_logs_user")
  @@index([organization_id], map: "idx_sap_logs_org")
  @@index([test_execution_id], map: "idx_sap_logs_test")
  @@index([created_at], map: "idx_sap_logs_created")
  @@index([success], map: "idx_sap_logs_success")
}
